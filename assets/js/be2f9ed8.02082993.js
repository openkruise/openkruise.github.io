"use strict";(self.webpackChunkopenkruise_io=self.webpackChunkopenkruise_io||[]).push([[9148],{3905:function(e,t,a){a.d(t,{Zo:function(){return p},kt:function(){return g}});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=n.createContext({}),u=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},p=function(e){var t=u(e.components);return n.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=u(a),g=r,d=m["".concat(l,".").concat(g)]||m[g]||c[g]||i;return a?n.createElement(d,o(o({ref:t},p),{},{components:a})):n.createElement(d,o({ref:t},p))}));function g(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,o=new Array(i);o[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var u=2;u<i;u++)o[u]=a[u];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},86200:function(e,t,a){a.r(t),a.d(t,{assets:function(){return p},contentTitle:function(){return l},default:function(){return g},frontMatter:function(){return s},metadata:function(){return u},toc:function(){return c}});var n=a(87462),r=a(63366),i=(a(67294),a(3905)),o=["components"],s={},l="Kruise Game API",u={unversionedId:"developer-manuals/kruise-game-api",id:"developer-manuals/kruise-game-api",title:"Kruise Game API",description:"kruise-game-api provides query, modification, and deletion operations on the GSS/GS resources of OKG through multiple interface types such as Golang package, gRPC, REST, and command line. The main functions are as follows:",source:"@site/kruisegame/developer-manuals/kruise-game-api.md",sourceDirName:"developer-manuals",slug:"/developer-manuals/kruise-game-api",permalink:"/kruisegame/developer-manuals/kruise-game-api",draft:!1,tags:[],version:"current",lastUpdatedBy:"Scott Liu",lastUpdatedAt:1740378822,formattedLastUpdatedAt:"2/24/2025",frontMatter:{},sidebar:"kruisegame",previous:{title:"Golang Client",permalink:"/kruisegame/developer-manuals/go-client"},next:{title:"ShangYou's Cloud-Native Practice of GameServers based on OpenKruiseGame",permalink:"/kruisegame/blog-video/kubecon-shangyou-20230926"}},p={},c=[{value:"Golang Package",id:"golang-package",level:2},{value:"REST",id:"rest",level:2},{value:"Command Line",id:"command-line",level:2},{value:"GS Status Query and Reporting",id:"gs-status-query-and-reporting",level:2},{value:"GS Routing Selection",id:"gs-routing-selection",level:2},{value:"Integration into PaaS Platform",id:"integration-into-paas-platform",level:2},{value:"Replace kubectl Client to Manage GSS&amp;GS",id:"replace-kubectl-client-to-manage-gssgs",level:2},{value:"Perform Automated Operations as a Step in CI/Workflow",id:"perform-automated-operations-as-a-step-in-ciworkflow",level:2}],m={toc:c};function g(e){var t=e.components,s=(0,r.Z)(e,o);return(0,i.kt)("wrapper",(0,n.Z)({},m,s,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"kruise-game-api"},"Kruise Game API"),(0,i.kt)("p",null,"kruise-game-api provides query, modification, and deletion operations on the GSS/GS resources of OKG through multiple interface types such as Golang package, gRPC, REST, and command line. The main functions are as follows:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Using a structured query syntax ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/CloudNativeGame/structured-filter-go"},"structured-filter-go")," similar to MongoDB, it realizes the query of relatively complex filtering rules for GSS/GS. For example, there is a requirement to query GSs that meet the following conditions:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"The opsState is None."),(0,i.kt)("li",{parentName:"ul"},"The status.networkStatus.currentState is Ready."),(0,i.kt)("li",{parentName:"ul"},"It contains containers named nginx and sidecar, where the image of nginx is nginx:1.27.4 and the image of sidecar is busybox:1.37.0.")))),(0,i.kt)("p",null,"You can use the following filter to query the list of GSs that meet all the above conditions:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-JSON"},'{\n  "$and": [\n    {\n      "opsState": "None"\n    },\n    {\n      "currentNetworkState": "Ready"\n    },\n    {\n      "images": {\n        "$all": ["nginx,nginx:1.27.4", "sidecar,busybox:1.37.0"]\n      }\n    }\n  ]\n}\n')),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Using ",(0,i.kt)("a",{parentName:"li",href:"https://jsonpatch.com/"},"JsonPatch")," as the update syntax and combining it with the filter, it realizes the state update of GSS/GS that meet certain filtering rules."),(0,i.kt)("li",{parentName:"ul"},"Providing a Golang Package to simplify the query and update syntax using chained calls:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-golang"},'// Construct the Filter\nfilter := filterbuilder.NewGsFilterBuilder().OpsState("None")\n\n// Construct the JsonPatch\npatcher := jsonpatchbuilder.NewGsJsonPatchBuilder().ReplaceUpdatePriority(1)\n')),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Providing gRPC/REST clients to further simplify the operations of GSS/GS:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-golang"},'// Create an HttpClient to send requests to the kruise-game-api-server\nclient := kruisegameapiclient.NewKruiseGameApiHttpClient()\n\n// Send an HTTP request to the kruise-game-api-server to set the updatePriority of GSs with opsState as None to 1\nresults, err := client.UpdateGameServers(filterbuilder.NewGsFilterBuilder().OpsState("None"),\n    jsonpatchbuilder.NewGsJsonPatchBuilder().ReplaceUpdatePriority(1))\n')),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Providing the kruisegamectl command-line tool to achieve structured query/update of GSS/GS without additional deployment:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'# Set the updatePriority of GSs with opsState as None to 1\nkruisegamectl -k "${kube_config_path}" \\\n    -r gameserver \\\n    -p -f \'{"opsState":"None"}\' \\\n    -j \'[{"op":"replace","path":"/spec/updatePriority","value":3}]\'\n')),(0,i.kt)("h1",{id:"usage"},"Usage"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Code examples: ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/CloudNativeGame/kruise-game-api/tree/main/examples"},"https://github.com/CloudNativeGame/kruise-game-api/tree/main/examples")),(0,i.kt)("li",{parentName:"ul"},"For more detailed interface descriptions and supported GSS/GS filters, etc., please refer to ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/CloudNativeGame/kruise-game-api/blob/main/README.md"},"README")),(0,i.kt)("li",{parentName:"ul"},"The following are the usage methods of several interface types such as Golang Package, REST, and command line:")),(0,i.kt)("h2",{id:"golang-package"},"Golang Package"),(0,i.kt)("p",null,"Get the package:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"go get github.com/CloudNativeGame/kruise-game-api\n")),(0,i.kt)("p",null,"Use it in the code:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-golang"},'// Create a GS filter\ngsFilter := filter.NewGsFilter(&filter.FilterOption{\n    KubeOption: options.KubeOption{\n        KubeConfigPath:          "~/.kube/config",\n        InformersReSyncInterval: time.Second * 30,\n    },\n})\n\n//rawFilter := "{\\"$and\\":[{\\"opsState\\": \\"None\\"}, {\\"updatePriority\\": 0}]}"\n// Get the list of GSs with opsState as None and updatePriority as 0\ngameServers, err := gsFilter.GetFilteredGameServers(filterBuilder.And().OpsState("None").UpdatePriority(0).Build())\n')),(0,i.kt)("h2",{id:"rest"},"REST"),(0,i.kt)("p",null,"Deploy the kruise-game-api-server to the kruise-game-system namespace:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"git clone git@github.com:CloudNativeGame/kruise-game-api.git\ncd kruise-game-api/deploy/ && kubectl apply -f .\n")),(0,i.kt)("p",null,"Use curl or the provided REST client Golang Package to request the kruise-game-api-server in the business container:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'# Get the list of GSs with opsState as None\ncurl -G --data-urlencode \'filter={"opsState":"None"}\' http://kruise-game-api-server.kruise-game-system/v1/gameservers\n')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-golang"},'// Create an HttpClient to send requests to the kruise-game-api-server\nclient := kruisegameapiclient.NewKruiseGameApiHttpClient()\n\n// Send an HTTP request to the kruise-game-api-server to get the list of GSs with opsState as None\ngameServers, err := client.GetGameServers(filterbuilder.NewGsFilterBuilder().OpsState("None"))\n')),(0,i.kt)("h2",{id:"command-line"},"Command Line"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'go install github.com/CloudNativeGame/kruise-game-api/facade/kruisegamectl@latest\n# The go/bin directory needs to be added to the PATH environment variable\nkruisegamectl -k ~/.kube/config -r gameserver -f \'{"opsState":"None"}\'\n')),(0,i.kt)("h1",{id:"use-cases"},"Use Cases"),(0,i.kt)("h2",{id:"gs-status-query-and-reporting"},"GS Status Query and Reporting"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Interact with the kruise-game-api-server through gRPC/REST requests to implement GS status query and reporting, replacing the way of updating GS status with custom service quality scripts and reducing the dependence on out-of-band systems."),(0,i.kt)("li",{parentName:"ul"},"GS can call requests through the sidecar or the kruise-game-api-server Service in the kruise-game-system namespace to manage its own status.")),(0,i.kt)("img",{src:a(46804).Z,style:{width:"800px"}}),(0,i.kt)("h2",{id:"gs-routing-selection"},"GS Routing Selection"),(0,i.kt)("p",null,"The kruise-game-api-server can be used in the sidecar of the gateway to help the gateway select and allocate GSs that meet the requirements."),(0,i.kt)("img",{src:a(53220).Z,style:{width:"800px"}}),(0,i.kt)("h2",{id:"integration-into-paas-platform"},"Integration into PaaS Platform"),(0,i.kt)("p",null,"If a self-developed PaaS platform is used, the functions such as filtering and updating of GSS/GS can be quickly integrated. For example, in the following figure, the GSSs can be filtered according to the image and the other conditions, and the images update of the filtered GSSs can be performed:"),(0,i.kt)("img",{src:a(44584).Z,style:{width:"800px"}}),(0,i.kt)("h2",{id:"replace-kubectl-client-to-manage-gssgs"},"Replace kubectl Client to Manage GSS&GS"),(0,i.kt)("p",null,"Provide the kruisegamectl command-line tool to implement the filtering and updating of GSS/GS without relying on the kruise-game-api-server."),(0,i.kt)("img",{src:a(87010).Z,style:{width:"800px"}}),(0,i.kt)("h2",{id:"perform-automated-operations-as-a-step-in-ciworkflow"},"Perform Automated Operations as a Step in CI/Workflow"),(0,i.kt)("p",null,"Take the following Argo Workflow as an example. Some steps are omitted. The last step, clean-old-none-gs, is to set the opsState of GSs that meet certain conditions (opsState is None, containing a container named game-server and the image of this container is nginx:1.27.4) to Kill:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'# kubectl create -f workflow.yaml\napiVersion: argoproj.io/v1alpha1\nkind: Workflow\nmetadata:\n  generateName: frame-sync-server-lossless-update-\n  namespace: kruise-game-system\nspec:\n  serviceAccountName: kruise-game-controller-manager\n  entrypoint: main\n  templates:\n    - name: main\n      steps:\n        - - name: clean-old-none-gs\n            template: clean-old-none-gs\n    - name: clean-old-none-gs\n      script:\n          image: crpi-8cm99ihkk1hz8ju9.cn-shenzhen.personal.cr.aliyuncs.com/scottliu/kruisegamectl:v0.0.5\n          command: ["/kruisegamectl"]\n          args:\n              - -r\n              - gameserver\n              - -f\n              - \'{"$and":[{"opsState":"None"},{"images":{"$all":["game-server,nginx:1.27.4"]}}]}\'\n              - -j\n              - \'[{"op":"replace","path":"/spec/opsState","value":"Kill"}]\'\n')))}g.isMDXComponent=!0},46804:function(e,t,a){t.Z=a.p+"assets/images/kruise-game-api-1-c3264fba8acf4593e818222bd5e66afd.png"},53220:function(e,t,a){t.Z=a.p+"assets/images/kruise-game-api-2-9c0904f58b5a2cef4c4445b115b37c0f.png"},44584:function(e,t,a){t.Z=a.p+"assets/images/kruise-game-api-3-22c3884737a265f124ae47c9d9ec4251.png"},87010:function(e,t,a){t.Z=a.p+"assets/images/kruise-game-api-4-8a9832bc3c141431669b16bf2b53e37a.png"}}]);